<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="travelMemberDAO">

	<typeAlias alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias alias="travelFamePoint" type="geocni.travel.member.domain.TravelFamePoint" />
	<typeAlias alias="travelFameHistory" type="geocni.travel.member.domain.TravelFameHistory" />
	<typeAlias alias="travelClipboard" type="geocni.travel.member.domain.TravelClipboard" />
	<typeAlias alias="travelReaction" type="geocni.travel.member.domain.TravelReaction" />
	<typeAlias alias="travelDestination" type="geocni.travel.route.domain.TravelDestination" />

	<!-- 명성 적립 정보 -->
	<insert id="travelMemberDAO.upsertTravelFamePoint">
		<![CDATA[
			INSERT INTO geo_fame_point (
				  fame_user_id
				, fame_ranking
				, fame_point_sum
				, fame_reco_case
				, fame_shared_case
			) VALUES (				
				  #fameUserId#
				, #fameRanking#
				, #famePointSum#
				, #fameRecoCase#
				, #fameSharedCase#
			) ON DUPLICATE KEY UPDATE 
				  fame_ranking=#fameRanking# 
				, fame_point_sum=#famePointSum#
				, fame_reco_case=#fameRecoCase#
				, fame_shared_case=#fameSharedCase#
		]]>
	</insert> 

	<insert id="travelMemberDAO.upsertTravelFamePointByReco">
		<![CDATA[
			INSERT INTO geo_fame_point (
				  fame_user_id
				, fame_point_sum
				, fame_reco_case
			) VALUES (				
				  #fameUserId#
				, #famePointSum#
				, 1
			) ON DUPLICATE KEY UPDATE 
				  fame_point_sum=(fame_point_sum + #famePointSum#)
				, fame_reco_case=(fame_reco_case + 1)
		]]>
	</insert>
	
	<insert id="travelMemberDAO.upsertTravelFamePointByShare">
		<![CDATA[
			INSERT INTO geo_fame_point (
				  fame_user_id
				, fame_point_sum
				, fame_shared_case
			) VALUES (				
				  #fameUserId#
				, #famePointSum#
				, 1
			) ON DUPLICATE KEY UPDATE 
				  fame_point_sum=(fame_point_sum + #famePointSum#)
				, fame_shared_case=(fame_shared_case + 1)
		]]>
	</insert>

	<update id="travelMemberDAO.updateTravelFamePointRanking">
		<!-- 포인트 누적 순서대로 랭킹 재정렬 -->
		<![CDATA[
			SELECT @rank:=0;
			UPDATE geo_fame_point SET fame_ranking=@rank:=@rank+1 ORDER BY fame_point_sum DESC 
		]]>
	</update> 
	<!-- 
	<update id="travelMemberDAO.updateTravelFamePoint">
		<![CDATA[
			UPDATE geo_fame_point
			SET 
				  fame_ranking=#fameRanking#
				, fame_point_sum=#famePointSum#
				, fame_reco_case=#fameRecoCase#
				, fame_shared_case=#fameSharedCase#
			WHERE fame_user_id=#fameUserId#
		]]>
	</update> 
	-->
	
	<delete id="travelMemberDAO.deleteTravelFamePointPhysically">
	    <![CDATA[
			DELETE FROM geo_fame_point
            WHERE fame_user_id=#fameUserId#
		]]>
	</delete>

	<!-- 로그인 기록 내 특정 아이디(일간 기준) 카운트 -->
	<!-- 
	SELECT COUNT(*) FROM (
	    SELECT DATE(created) AS created_date
	         , MBR_ID
	    FROM jnitloginlog
	    GROUP BY DATE_FORMAT(created, '%Y-%m-%d'), mbr_id
	) AS ta
	WHERE ta.MBR_ID='MBR_0000000001' 
	-->

	<!-- 
	point_sum 기준으로 랭킹 재정렬
	SELECT
	    fame_user_id, fame_ranking, fame_point_sum,
	    ( SELECT COUNT(*) + 1 FROM geo_fame_point WHERE fame_point_sum > b.fame_point_sum ) AS rank
	FROM
	    geo_fame_point AS b
	ORDER BY
	    rank ASC 
	-->

	

	<!-- 
	<select id="travelMemberDAO.selectTravelFamePoint" parameterClass="java.lang.String" resultClass="travelFamePoint">
		<![CDATA[
			SELECT 
				  IFNULL(sum(popul_recomm_point), 0) AS populRecommPointSum
				, 201 AS popularityRanking  
				, IFNULL(count(popul_id), 0) AS populRecommCase  
				, 4 AS populSharedCase  
			FROM geo_fame_history     
			WHERE popul_recomm_user_id=#memberId#;
		]]>
	</select> 
	-->
	<select id="travelMemberDAO.selectTravelFamePoint" parameterClass="java.lang.String" resultClass="travelFamePoint">
		<![CDATA[
			SELECT
				  a.fame_user_id AS fameUserId
				, IFNULL(a.fame_ranking, 0) AS fameRanking
				, IFNULL(a.fame_point_sum, 0) AS famePointSum
				, IFNULL(a.fame_reco_case, 0) AS fameRecoCase
				, IFNULL(a.fame_shared_case, 0) AS fameSharedCase
				, b.mbr_nm AS fameUserNm
			FROM geo_fame_point a
				LEFT JOIN jnitcmsmbr b ON a.fame_user_id=b.mbr_id
            WHERE a.fame_user_id=#fameUserId#
		]]>
	</select>
	
	<select id="travelMemberDAO.selectTravelFamePointList" parameterClass="travelFamePoint" resultClass="travelFamePoint">
		<![CDATA[
			SELECT
				  a.fame_user_id AS fameUserId
				, a.fame_ranking AS fameRanking
				, a.fame_point_sum AS famePointSum
				, a.fame_reco_case AS fameRecoCase
				, a.fame_shared_case AS fameSharedCase
				, IFNULL(b.mbr_nm, '비회원') AS fameUserNm
				, b.mbr_photo AS fameUserPic
			FROM geo_fame_point a
				LEFT JOIN jnitcmsmbr b ON a.fame_user_id=b.mbr_id
			WHERE 1=1
		]]>
		<![CDATA[
			ORDER BY fame_ranking ASC
            LIMIT #firstIndex#, #recordCountPerPage#
		]]>
	</select>	
	<select id="travelMemberDAO.selectTravelFamePointListCnt" parameterClass="travelFamePoint" resultClass="int">
		<![CDATA[
			SELECT 
				COUNT(*) totcnt
			FROM geo_fame_point a
			WHERE 1=1
		]]>
	</select>
	<!--/명성 적립 정보 -->


	<!-- 명성 적립 내역 -->
	<insert id="travelMemberDAO.insertTravelFameHistory">
		<![CDATA[
			INSERT INTO geo_fame_history (
				  fame_his_id
				, fame_his_point
				, fame_his_type
				, fame_his_item
				, fame_his_rec_user
				, fame_his_date
			) VALUES (
				  #fameHisId#
				, #fameHisPoint#
				, #fameHisType#
				, #fameHisItem#
				, #fameHisRecUser#
				, NOW()
			)
		]]>
	</insert>
	
	<update id="travelMemberDAO.updateTravelFameHistory">
		<![CDATA[
			UPDATE geo_fame_history
			SET 
				  fame_his_point=#fameHisPoint#
				, fame_his_type=#fameHisType#
				, fame_his_item=#fameHisItem#
			WHERE fame_his_id=#fameHisId#
		]]>
				<!-- 
				, fame_his_rec_user=#fameHisRecUser#
				, fame_his_date=#fameHisDate# 
				-->
	</update>
	
	<delete id="travelMemberDAO.deleteTravelFameHistoryPhysically">
	    <![CDATA[
			DELETE FROM geo_fame_history
            WHERE fame_his_id=#fameHisId#
		]]>
	</delete>

	<select id="travelMemberDAO.selectTravelFameHistory" parameterClass="travelFameHistory" resultClass="travelFameHistory">
		<![CDATA[
			SELECT
				  a.fame_his_id AS fameHisId
				, a.fame_his_point AS fameHisPoint
				, a.fame_his_type AS fameHisType
				, a.fame_his_item AS fameHisItem
				, a.fame_his_rec_user AS fameHisRecUser
				, a.fame_his_date AS fameHisDate
				, b.mbr_nm AS fameHisRecUserNm
			FROM geo_fame_history a
				LEFT JOIN jnitcmsmbr b ON a.fame_his_rec_user=b.mbr_id
            WHERE a.fame_his_id=#fameHisId#
		]]>
	</select>
	
	<select id="travelMemberDAO.selectTravelFameHistoryList" parameterClass="travelFameHistory" resultClass="travelFameHistory">
		<![CDATA[
			SELECT
				  a.fame_his_id AS fameHisId
				, a.fame_his_point AS fameHisPoint
				, a.fame_his_type AS fameHisType
				, a.fame_his_item AS fameHisItem
				, a.fame_his_rec_user AS fameHisRecUser
				, a.fame_his_date AS fameHisDate
				, b.mbr_nm AS fameHisRecUserNm
			FROM geo_fame_history a
				LEFT JOIN jnitcmsmbr b ON a.fame_his_rec_user=b.mbr_id
			WHERE 1=1
				AND	a.fame_his_rec_user = #fameHisRecUser#
		]]>
			<!-- <isNotEqual property="adminMode" compareValue="true">
				<isEmpty property="routGroup" prepend="AND">
					a.rout_days = '1'
				</isEmpty>
				<isNotEmpty property="routGroup" prepend="AND">
					a.rout_group = #routGroup#
				</isNotEmpty>
			</isNotEqual>
			
			<isNotEmpty property="routRegion" prepend="AND">
				a.rout_region = #routRegion#
			</isNotEmpty>
			<isNotEmpty property="searchKeyword" prepend="AND">
				a.rout_title LIKE CONCAT('%',#searchKeyword#,'%')
			</isNotEmpty> -->
		<![CDATA[
			ORDER BY fame_his_date DESC
            LIMIT #firstIndex#, #recordCountPerPage#
		]]>
	</select>	
	<select id="travelMemberDAO.selectTravelFameHistoryListCnt" parameterClass="travelFameHistory" resultClass="int">
		<![CDATA[
			SELECT 
				COUNT(*) totcnt
			FROM geo_fame_history a
			WHERE 1=1
				AND	a.fame_his_rec_user = #fameHisRecUser#
		]]>
			<!-- <isNotEqual property="adminMode" compareValue="true">
				<isEmpty property="routGroup" prepend="AND">
					a.rout_days = '1'
				</isEmpty>
				<isNotEmpty property="routGroup" prepend="AND">
					a.rout_group = #routGroup#
				</isNotEmpty>
			</isNotEqual>
			
			<isNotEmpty property="routRegion" prepend="AND">
				a.rout_region = #routRegion#
			</isNotEmpty>
			<isNotEmpty property="searchKeyword" prepend="AND">
				a.rout_title LIKE CONCAT('%',#searchKeyword#,'%')
			</isNotEmpty> -->
	</select>

	<select id="travelMemberDAO.selectTravelFameHistoryCntByUser" parameterClass="java.lang.String" resultClass="int">
		<![CDATA[
			SELECT COUNT(*) FROM geo_fame_history 
			WHERE fame_his_rec_user=#fameHisRecUser#
				AND fame_his_type='L'	
				AND DATE_FORMAT(fame_his_date, "%Y-%m-%d")=CURDATE()
		]]>
	</select>
	<!--/명성 적립 내역 -->


	<!-- 클립보드 -->
	<insert id="travelMemberDAO.insertTravelClipboard">
		<![CDATA[
			INSERT INTO geo_clipboard (
				  clip_id
				, clip_page_id
				, clip_title
				, clip_page_url
				, clip_thumb_path
				, clip_user_id
				, clip_reg_date
			) VALUES (
				  #clipId#
				, #clipPageId#
				, #clipTitle#
				, #clipPageUrl#
				, #clipThumbPath#
				, #clipUserId#
				, NOW()
			)
		]]>
	</insert>
	
	<update id="travelMemberDAO.updateTravelClipboard">
		<![CDATA[
			UPDATE geo_clipboard
			SET 
				  clip_title=#clipTitle#
				, clip_page_url=#clipPageUrl#
				, clip_thumb_path=#clipThumbPath#
				, clip_user_id=#clipUserId#
			WHERE clip_id=#clipId#
		]]>
				<!-- , clip_reg_date=#clipRegDate# -->
	</update>
	
	<delete id="travelMemberDAO.deleteTravelClipboardPhysically">
	    <![CDATA[
			DELETE FROM geo_clipboard
            WHERE clip_id=#clipId#
		]]>
	</delete>
	
	<select id="travelMemberDAO.selectTravelClipboard" parameterClass="travelClipboard" resultClass="travelClipboard">
		<![CDATA[
			SELECT
				  a.clip_id AS clipId
				, CONCAT(b.dest_category, '|' , b.dest_title) AS clipTitle
				, a.clip_page_id AS clipPageId
				, b.dest_address AS clipPageUrl
		]]>
				<!-- , a.clip_page_url AS clipPageUrl -->
		<![CDATA[
				, b.dest_img_path AS clipThumbPath
				, a.clip_user_id AS clipUserId
				, a.clip_reg_date AS clipRegDate
				, c.mbr_nm AS clipUserNm
			FROM geo_clipboard a
				LEFT JOIN geo_destination b ON a.clip_page_id=b.dest_id
				LEFT JOIN jnitcmsmbr c ON a.clip_user_id=c.mbr_id
            WHERE a.clip_id=#clipId#
		]]>
	</select>
	
	<select id="travelMemberDAO.selectTravelClipboardList" parameterClass="travelClipboard" resultClass="travelClipboard">
		<![CDATA[
			SELECT
				  a.clip_id AS clipId
				, a.clip_page_id AS clipPageId
				, CONCAT(b.dest_category, '|' , b.dest_title) AS clipTitle
				, b.dest_address AS clipPageUrl
				, b.dest_img_path AS clipThumbPath
				, a.clip_user_id AS clipUserId
				, a.clip_reg_date AS clipRegDate
				, c.mbr_nm AS clipUserNm
			FROM geo_clipboard a
				LEFT JOIN geo_destination b ON a.clip_page_id=b.dest_id
				LEFT JOIN jnitcmsmbr c ON a.clip_user_id=c.mbr_id
			WHERE 1=1
		]]>
			<isNotEmpty property="clipUserId" prepend="AND">
			<![CDATA[	a.clip_user_id = #clipUserId#	]]>
			</isNotEmpty>
		<![CDATA[
			ORDER BY clip_reg_date DESC
            LIMIT #firstIndex#, #recordCountPerPage#
		]]>
	</select>	
	<select id="travelMemberDAO.selectTravelClipboardListCnt" parameterClass="travelClipboard" resultClass="int">
		<![CDATA[
			SELECT 
				COUNT(*) totcnt
			FROM geo_clipboard a
			WHERE 1=1
		]]>
			<isNotEmpty property="clipUserId" prepend="AND">
			<![CDATA[	a.clip_user_id = #clipUserId#	]]>
			</isNotEmpty>
	</select>

	<select id="travelMemberDAO.selectTravelClipDestinationList" parameterClass="travelClipboard" resultClass="travelDestination">
		<![CDATA[
			SELECT
				  b.dest_id AS destId
				, b.dest_title AS destTitle
				, b.dest_ad_slogan AS destAdSlogan
				, b.dest_region AS destRegion
				, b.dest_category AS destCategory
				, b.dest_tag AS destTag
				, b.dest_website_url AS destWebsiteUrl
				, b.dest_img_path AS destImgPath
				, b.dest_phone AS destPhone
				, b.dest_address AS destAddress
				, b.dest_axis_x AS destAxisX
				, b.dest_axis_y AS destAxisY
				, b.dest_feature AS destFeature
				, b.dest_information AS destInformation
				, b.dest_description AS destDescription
				, b.dest_recomm_point AS destRecommPoint
				, b.dest_clip_point AS destClipPoint
				, b.dest_writer AS destWriter
				, b.dest_reg_datetime AS destRegDatetime
				, b.dest_hit AS destHit
			FROM geo_clipboard a
				INNER JOIN geo_destination b ON a.clip_page_id=b.dest_id
				INNER JOIN jnitcmsmbr c ON a.clip_user_id=c.mbr_id
			WHERE 1=1
		]]>
			<isNotEmpty property="clipUserId" prepend="AND">
			<![CDATA[	a.clip_user_id = #clipUserId#	]]>
			</isNotEmpty>
		<![CDATA[
			ORDER BY clip_reg_date DESC
            LIMIT #firstIndex#, #recordCountPerPage#
		]]>
	</select>	
	<select id="travelMemberDAO.selectTravelClipDestinationListCnt" parameterClass="travelClipboard" resultClass="int">
		<![CDATA[
			SELECT 
				COUNT(*) totcnt
			FROM geo_clipboard a
			WHERE 1=1
		]]>
			<isNotEmpty property="clipUserId" prepend="AND">
			<![CDATA[	a.clip_user_id = #clipUserId#	]]>
			</isNotEmpty>
	</select>

	<select id="travelMemberDAO.selectTravelClipboardCnt" parameterClass="travelClipboard" resultClass="int">
		<![CDATA[
			SELECT 
				COUNT(*) clipCnt
			FROM geo_clipboard
			WHERE 1=1
				AND clip_page_id=#clipPageId#
				AND clip_user_id=#clipUserId#
		]]>
	</select>
	
	<delete id="travelMemberDAO.deleteclipboard">
	    <![CDATA[
			DELETE FROM geo_clipboard
            WHERE clip_page_id=#clipPageId#
            	AND clip_user_id=#clipUserId#
		]]>
	</delete>
	<!--/클립보드 -->

	<!-- 리액션 -->
	<insert id="travelMemberDAO.insertTravelReaction">
		<![CDATA[
			INSERT INTO geo_reaction (
				  rxn_id
				, rxn_user_id
				, rxn_target_id
				, rxn_type
				, rxn_reg_date
			) VALUES (
				  #rxnId#
				, #rxnUserId#
				, #rxnTargetId#
				, #rxnType#
				, NOW()
			)
		]]>
	</insert>
	
	<update id="travelMemberDAO.updateTravelReaction">
		<![CDATA[
			UPDATE geo_reaction
			SET 
				  rxn_user_id=#rxnUserId#
				, rxn_target_id=#rxnTargetId#
				, rxn_type=#rxnType#
			WHERE rxn_id=#rxnId#
		]]>
				<!-- , clip_reg_date=#clipRegDate# -->
	</update>
	
	<delete id="travelMemberDAO.deleteTravelReactionPhysically">
	    <![CDATA[
			DELETE FROM geo_reaction
            WHERE rxn_id=#rxnId#
		]]>
	</delete>
	
	<select id="travelMemberDAO.selectTravelReaction" parameterClass="travelReaction" resultClass="travelReaction">
		<![CDATA[
			SELECT
				  a.rxn_id AS rxnId
				, a.rxn_user_id AS rxnUserId
				, a.rxn_target_id AS rxnTargetId
				, a.rxn_type AS rxnType
				, a.rxn_reg_date AS rxnRegDate
				, b.mbr_nm AS rxnUserNm
			FROM geo_reaction a
				LEFT JOIN jnitcmsmbr b ON a.rxn_user_id=b.mbr_id
            WHERE a.rxn_id=#rxnId#
		]]>
	</select>
	
	<select id="travelMemberDAO.selectTravelReactionList" parameterClass="travelReaction" resultClass="travelReaction">
		<![CDATA[
			SELECT
				  a.rxn_id AS rxnId
				, a.rxn_user_id AS rxnUserId
				, a.rxn_target_id AS rxnTargetId
				, a.rxn_type AS rxnType
				, a.rxn_reg_date AS rxnRegDate
				, b.mbr_nm AS rxnUserNm
			FROM geo_reaction a
				LEFT JOIN jnitcmsmbr b ON a.rxn_user_id=b.mbr_id
			WHERE 1=1
		]]>
		<![CDATA[
			ORDER BY clip_reg_date DESC
            LIMIT #firstIndex#, #recordCountPerPage#
		]]>
	</select>	
	<select id="travelMemberDAO.selectTravelReactionListCnt" parameterClass="travelReaction" resultClass="int">
		<![CDATA[
			SELECT 
				COUNT(*) totcnt
			FROM geo_reaction a
			WHERE 1=1
		]]>
	</select>

	<select id="travelMemberDAO.selectTravelReactionCnt" parameterClass="travelReaction" resultClass="int">
		<![CDATA[
			SELECT 
				COUNT(*) rxnCnt
			FROM geo_reaction
			WHERE 1=1
				AND rxn_user_id=#rxnUserId#
				AND rxn_target_id=#rxnTargetId#
				AND rxn_type=#rxnType#
		]]>
	</select>
	
	<delete id="travelMemberDAO.deleteLike">
	    <![CDATA[
			DELETE FROM geo_reaction
            WHERE rxn_type=#rxnType#
           	 AND rxn_target_id=#rxnTargetId#
           	 AND rxn_user_id=#rxnUserId#
		]]>
	</delete>
	<!--/리액션 -->

</sqlMap>
