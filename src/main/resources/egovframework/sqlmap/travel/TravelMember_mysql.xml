<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="travelMemberDAO">

	<typeAlias alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias alias="travelFamePoint" type="geocni.travel.member.domain.TravelFamePoint" />
	<typeAlias alias="travelFameHistory" type="geocni.travel.member.domain.TravelFameHistory" />
	<typeAlias alias="travelClipboard" type="geocni.travel.member.domain.TravelClipboard" />

	<!-- 명성 적립 정보 -->
	<insert id="travelMemberDAO.upsertTravelFamePoint">
		<![CDATA[
			INSERT INTO geo_fame_point (
				  fame_user_id
				, fame_ranking
				, fame_point_sum
				, fame_reco_case
				, fame_shared_case
			) VALUES (				
				  #fameUserId#
				, #fameRanking#
				, #famePointSum#
				, #fameRecoCase#
				, #fameSharedCase#
			) ON DUPLICATE KEY UPDATE 
				  fame_ranking=#fameRanking# 
				, fame_point_sum=#famePointSum#
				, fame_reco_case=#fameRecoCase#
				, fame_shared_case=#fameSharedCase#
		]]>
	</insert>
	
	<!-- 
	포인트 누적 순서대로 랭킹 재정렬
	SELECT @rank:=0;
	UPDATE geo_fame_point SET FAME_RANKING=@rank:=@rank+1 ORDER BY FAME_POINT_SUM desc ; 
	-->
	<!-- <update id="travelMemberDAO.updateTravelFamePoint">
		<![CDATA[
			UPDATE geo_fame_point
			SET 
				  fame_ranking=#fameRanking#
				, fame_point_sum=#famePointSum#
				, fame_reco_case=#fameRecoCase#
				, fame_shared_case=#fameSharedCase#
			WHERE fame_user_id=#fameUserId#
		]]>
	</update> -->
	
	<delete id="travelMemberDAO.deleteTravelFamePointPhysically">
	    <![CDATA[
			DELETE FROM geo_fame_point
            WHERE fame_user_id=#fameUserId#
		]]>
	</delete>

	<!-- 로그인 기록 내 특정 아이디(일간 기준) 카운트 -->
	<!-- 
	SELECT COUNT(*) FROM (
	    SELECT DATE(created) AS created_date
	         , MBR_ID
	    FROM jnitloginlog
	    GROUP BY DATE_FORMAT(created, '%Y-%m-%d'), mbr_id
	) AS ta
	WHERE ta.MBR_ID='MBR_0000000001' 
	-->

	<!-- 
	point_sum 기준으로 랭킹 재정렬
	SELECT
	    fame_user_id, fame_ranking, fame_point_sum,
	    ( SELECT COUNT(*) + 1 FROM geo_fame_point WHERE fame_point_sum > b.fame_point_sum ) AS rank
	FROM
	    geo_fame_point AS b
	ORDER BY
	    rank ASC 
	-->

	

	<!-- 
	<select id="travelMemberDAO.selectTravelFamePoint" parameterClass="java.lang.String" resultClass="travelFamePoint">
		<![CDATA[
			SELECT 
				  IFNULL(sum(popul_recomm_point), 0) AS populRecommPointSum
				, 201 AS popularityRanking  
				, IFNULL(count(popul_id), 0) AS populRecommCase  
				, 4 AS populSharedCase  
			FROM geo_fame_history     
			WHERE popul_recomm_user_id=#memberId#;
		]]>
	</select> 
	-->
	<select id="travelMemberDAO.selectTravelFamePoint" parameterClass="java.lang.String" resultClass="travelFamePoint">
		<![CDATA[
			SELECT
				  a.fame_user_id AS fameUserId
				, IFNULL(a.fame_ranking, 0) AS fameRanking
				, IFNULL(a.fame_point_sum, 0) AS famePointSum
				, IFNULL(a.fame_reco_case, 0) AS fameRecoCase
				, IFNULL(a.fame_shared_case, 0) AS fameSharedCase
				, b.mbr_nm AS fameUserNm
			FROM geo_fame_point a
				LEFT JOIN jnitcmsmbr b ON a.fame_user_id=b.mbr_id
            WHERE a.fame_user_id=#fameUserId#
		]]>
	</select>
	
	<select id="travelMemberDAO.selectTravelFamePointList" parameterClass="travelFamePoint" resultClass="travelFamePoint">
		<![CDATA[
			SELECT
				  a.fame_user_id AS fameUserId
				, a.fame_ranking AS fameRanking
				, a.fame_point_sum AS famePointSum
				, a.fame_reco_case AS fameRecoCase
				, a.fame_shared_case AS fameSharedCase
				, IFNULL(b.mbr_nm, '비회원') AS fameUserNm
			FROM geo_fame_point a
				LEFT JOIN jnitcmsmbr b ON a.fame_user_id=b.mbr_id
			WHERE 1=1
		]]>
		<![CDATA[
			ORDER BY fame_ranking ASC
            LIMIT #firstIndex#, #recordCountPerPage#
		]]>
	</select>	
	<select id="travelMemberDAO.selectTravelFamePointListCnt" parameterClass="travelFamePoint" resultClass="int">
		<![CDATA[
			SELECT 
				COUNT(*) totcnt
			FROM geo_fame_point a
			WHERE 1=1
		]]>
	</select>
	<!--/명성 적립 정보 -->


	<!-- 명성 적립 내역 -->
	<insert id="travelMemberDAO.insertTravelFameHistory">
		<![CDATA[
			INSERT INTO geo_fame_history (
				  fame_his_id
				, fame_his_point
				, fame_his_type
				, fame_his_item
				, fame_his_rec_user
				, fame_his_date
			) VALUES (
				  #fameHisId#
				, #fameHisPoint#
				, #fameHisType#
				, #fameHisItem#
				, #fameHisRecUser#
				, NOW()
			)
		]]>
	</insert>
	
	<update id="travelMemberDAO.updateTravelFameHistory">
		<![CDATA[
			UPDATE geo_fame_history
			SET 
				  fame_his_point=#fameHisPoint#
				, fame_his_type=#fameHisType#
				, fame_his_item=#fameHisItem#
			WHERE fame_his_id=#fameHisId#
		]]>
				<!-- 
				, fame_his_rec_user=#fameHisRecUser#
				, fame_his_date=#fameHisDate# 
				-->
	</update>
	
	<delete id="travelMemberDAO.deleteTravelFameHistoryPhysically">
	    <![CDATA[
			DELETE FROM geo_fame_history
            WHERE fame_his_id=#fameHisId#
		]]>
	</delete>

	<select id="travelMemberDAO.selectTravelFameHistory" parameterClass="travelFameHistory" resultClass="travelFameHistory">
		<![CDATA[
			SELECT
				  a.fame_his_id AS fameHisId
				, a.fame_his_point AS fameHisPoint
				, a.fame_his_type AS fameHisType
				, a.fame_his_item AS fameHisItem
				, a.fame_his_rec_user AS fameHisRecUser
				, a.fame_his_date AS fameHisDate
				, b.mbr_nm AS fameHisRecUserNm
			FROM geo_fame_history a
				LEFT JOIN jnitcmsmbr b ON a.fame_his_rec_user=b.mbr_id
            WHERE a.fame_his_id=#fameHisId#
		]]>
	</select>
	
	<select id="travelMemberDAO.selectTravelFameHistoryList" parameterClass="travelFameHistory" resultClass="travelFameHistory">
		<![CDATA[
			SELECT
				  a.fame_his_id AS fameHisId
				, a.fame_his_point AS fameHisPoint
				, a.fame_his_type AS fameHisType
				, a.fame_his_item AS fameHisItem
				, a.fame_his_rec_user AS fameHisRecUser
				, a.fame_his_date AS fameHisDate
				, b.mbr_nm AS fameHisRecUserNm
			FROM geo_fame_history a
				LEFT JOIN jnitcmsmbr b ON a.fame_his_rec_user=b.mbr_id
			WHERE 1=1
		]]>
			<!-- <isNotEqual property="adminMode" compareValue="true">
				<isEmpty property="routGroup" prepend="AND">
					a.rout_days = '1'
				</isEmpty>
				<isNotEmpty property="routGroup" prepend="AND">
					a.rout_group = #routGroup#
				</isNotEmpty>
			</isNotEqual>
			
			<isNotEmpty property="routRegion" prepend="AND">
				a.rout_region = #routRegion#
			</isNotEmpty>
			<isNotEmpty property="searchKeyword" prepend="AND">
				a.rout_title LIKE CONCAT('%',#searchKeyword#,'%')
			</isNotEmpty> -->
		<![CDATA[
			ORDER BY fame_his_date DESC
            LIMIT #firstIndex#, #recordCountPerPage#
		]]>
	</select>	
	<select id="travelMemberDAO.selectTravelFameHistoryListCnt" parameterClass="travelFameHistory" resultClass="int">
		<![CDATA[
			SELECT 
				COUNT(*) totcnt
			FROM geo_fame_history a
			WHERE 1=1
		]]>
			<!-- <isNotEqual property="adminMode" compareValue="true">
				<isEmpty property="routGroup" prepend="AND">
					a.rout_days = '1'
				</isEmpty>
				<isNotEmpty property="routGroup" prepend="AND">
					a.rout_group = #routGroup#
				</isNotEmpty>
			</isNotEqual>
			
			<isNotEmpty property="routRegion" prepend="AND">
				a.rout_region = #routRegion#
			</isNotEmpty>
			<isNotEmpty property="searchKeyword" prepend="AND">
				a.rout_title LIKE CONCAT('%',#searchKeyword#,'%')
			</isNotEmpty> -->
	</select>
	<!--/명성 적립 내역 -->


	<!-- 클립보드 -->
	<insert id="travelMemberDAO.insertTravelClipboard">
		<![CDATA[
			INSERT INTO geo_clipboard (
				  clip_id
				, clip_title
				, clip_page_url
				, clip_thumb_path
				, clip_user_id
				, clip_reg_date
			) VALUES (
				  #clipId#
				, #clipTitle#
				, #clipPageUrl#
				, #clipThumbPath#
				, #clipUserId#
				, NOW()
			)
		]]>
	</insert>
	
	<update id="travelMemberDAO.updateTravelClipboard">
		<![CDATA[
			UPDATE geo_clipboard
			SET 
				  clip_title=#clipTitle#
				, clip_page_url=#clipPageUrl#
				, clip_thumb_path=#clipThumbPath#
				, clip_user_id=#clipUserId#
			WHERE clip_id=#clipId#
		]]>
				<!-- , clip_reg_date=#clipRegDate# -->
	</update>
	
	<delete id="travelMemberDAO.deleteTravelClipboardPhysically">
	    <![CDATA[
			DELETE FROM geo_clipboard
            WHERE clip_id=#clipId#
		]]>
	</delete>
	
	<select id="travelMemberDAO.selectTravelClipboard" parameterClass="travelClipboard" resultClass="travelClipboard">
		<![CDATA[
			SELECT
				  a.clip_id AS clipId
				, CONCAT(b.dest_category, '|' , b.dest_title) AS clipTitle
				, a.clip_page_id AS clipPageId
				, b.dest_address AS clipPageUrl
		]]>
				<!-- , a.clip_page_url AS clipPageUrl -->
		<![CDATA[
				, b.dest_img_path AS clipThumbPath
				, a.clip_user_id AS clipUserId
				, a.clip_reg_date AS clipRegDate
				, c.mbr_nm AS clipUserNm
			FROM geo_clipboard a
				LEFT JOIN geo_destination b ON a.clip_page_id=b.dest_id
				LEFT JOIN jnitcmsmbr c ON a.clip_user_id=c.mbr_id
            WHERE a.clip_id=#clipId#
		]]>
	</select>
	
	<select id="travelMemberDAO.selectTravelClipboardList" parameterClass="travelClipboard" resultClass="travelClipboard">
		<![CDATA[
			SELECT
				  a.clip_id AS clipId
				, a.clip_page_id AS clipPageId
				, CONCAT(b.dest_category, '|' , b.dest_title) AS clipTitle
				, b.dest_address AS clipPageUrl
				, b.dest_img_path AS clipThumbPath
				, a.clip_user_id AS clipUserId
				, a.clip_reg_date AS clipRegDate
				, c.mbr_nm AS clipUserNm
			FROM geo_clipboard a
				LEFT JOIN geo_destination b ON a.clip_page_id=b.dest_id
				LEFT JOIN jnitcmsmbr c ON a.clip_user_id=c.mbr_id
			WHERE 1=1
		]]>
		<![CDATA[
			ORDER BY clip_reg_date DESC
            LIMIT #firstIndex#, #recordCountPerPage#
		]]>
	</select>	
	<select id="travelMemberDAO.selectTravelClipboardListCnt" parameterClass="travelClipboard" resultClass="int">
		<![CDATA[
			SELECT 
				COUNT(*) totcnt
			FROM geo_clipboard a
			WHERE 1=1
		]]>
	</select>
	<!--/클립보드 -->

</sqlMap>
